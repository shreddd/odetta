{% extends "base.html" %}

{% block head %}
	<script type="text/javascript" src="/static/js/d3.js"></script>
	<style type="text/css">
		.axis path,
        .axis line{
            fill:none;
            stroke:black;
            shape-rendering:crispEdges;
        }
        .axis text{
            font-family: sans-serif;
            font-size:11px;
        }
	</style>
	<script type="text/javascript">
		var spectrum_data = {{data|safe}};
		var flux_data = spectrum_data.flux_data;
		var width = 1000;
		var height = 500;
        var innerWidth = width - 100;
        var innerHeight = 75;
        var translatedX = 75
        var translatedY = -50;

		var xScale = d3.scale.linear()
			.domain([0,d3.max(flux_data,function(d){
				return d.wavelength;
			})])
			.range([0,innerWidth]);

		var yScale = d3.scale.linear()
			.domain([0,d3.max(flux_data,function(d){
				return d.lum;
			})])
			.range([height,innerHeight]);

		var xAxis = d3.svg.axis()
			.orient("bottom")
			.scale(xScale)

		var yAxis = d3.svg.axis()
			.orient("left")
			.scale(yScale)
            .tickFormat(function(d){
                return d.toExponential(1)
            });

		var lineFunction = d3.svg.line()
			.x(function(d){
                return xScale(d.wavelength);
            })
            .y(function(d){
                return yScale(d.lum);
            })
            .interpolate("linear");

		$(document).ready(function(){

			var svg = d3.select(".graph")
				.append("svg")
				.attr("width",width)
				.attr("height",height);

	        var chartBody = svg.append("g")
	        	.attr("class",chartBody)
	        	.attr("transform","translate("+ translatedX + ","+ translatedY +")");

	        // chartBody.selectAll("circle")
	        // 	.data(flux_data)
	        // 	.enter()
	        //     .append("circle")
	        //     .attr("r",3)
	        //     // .attr("stroke","black")
	        //     // .attr("stroke-width","1px")
	        //     .attr("fill","teal")
	        //     .attr("cx",function(d){
	        //         return xScale(d.wavelength);
	        //     })
	        //     .attr("cy",function(d){
	        //         return yScale(height - d.lum);
	        //     })
	        //     .attr("class","chartBody");
	            // resetListeners();

  			svg.append("g")
	            .attr("class","axis")
	            .attr("transform","translate(" + translatedX + "," + (height + translatedY) + ")")
	            .call(xAxis);

	        svg.append("g")
	            .attr("class","axis")
	            .attr("transform","translate("+ translatedX + "," + translatedY + ")")
	            .call(yAxis);

            svg.append("text")
                .attr("class","labels")
                .attr("text-anchor","end")
                .attr("x",innerWidth/2 + translatedX)
                .attr("y",height - 5)
                .text("Wavelength");

            svg.append("text")
                .attr("class","labels")
                .attr("text-anchor","end")
                .attr("y",0)
                .attr("x",-(height / 2) - translatedY)
                .attr("dy","0.75em")
                .attr("transform","rotate(-90)")
                .text("Luminosity");

            function drawGraph(dataset){
                var lineGraph = chartBody.append("path")
                .attr("d",lineFunction(dataset))
                .attr("stroke","teal")
                .attr("stroke-width",2)
                .attr("fill","none")
                .attr("class","chartBody");
            }

	        function resetListeners(){
            d3.selectAll("circle").on("mouseover",null);
            d3.selectAll("circle").on("mouseout",null);
            d3.selectAll("circle")
                .on("mouseover",function(d,i){
                    d3.select(this)
                        .transition()
                        .duration(500)
                        // .attr("fill","black")
                        .attr("opacity",0.75)
                        .attr("r", 15);

                    svg.append("rect")
                        .attr("width",0)
                        .attr("height",0)
                        .attr("fill","lightgray")
                        .transition()
                        .duration(500)
                        .attr("width",75)
                        .attr("height",50)
                        .attr("x",function(){
                          return xScale(d[0] + 5);
                        })
                        .attr("y",function(){
                          return yScale(d[1]);
                        })
                        .attr("stroke","black")
                        .attr("stroke-width",2)
                        .attr("class","infoBox");

                    svg.append("text")
                        .attr("opacity",0)
                        .transition()
                        .duration(500)
                        .text("x:" + d[0])
                        .attr("x",function(){
                            return xScale(d[0] + 20);
                        })
                        .attr("y", function(){
                            return yScale(d[1]-15);
                        })
                        .attr("fill","black")
                        .attr("font-family","sans-serif")
                        .attr("class","info")
                        .attr("opacity",1.0);
                    svg.append("text")
                        .attr("opacity",0)
                        .transition()
                        .duration(500)
                        .text("y:" + d[1])
                        .attr("x",function(){
                            return xScale(d[0] + 20);
                        }) 
                        .attr("y", function(){
                            return yScale(d[1]-30);
                        })
                        .attr("fill","black")
                        .attr("font-family","sans-serif")
                        .attr("class","info")
                        .attr("opacity",1.0);
                })
                .on("mouseout",function(d){
                    d3.select(this)
                        .transition()
                        .duration(400)
                        .attr("opacity",1)
                        .attr("r",function(d){
                            return 5;
                    });
                    svg.selectAll(".infoBox")
                        .transition()
                        .duration(500)
                        .attr("width",0)
                        .attr("height",0)
                        .remove();
                    svg.selectAll(".info")
                        .transition()
                        .duration(250)
                        .remove();
                });
            }
	       drawGraph(flux_data);
	     });
	</script>
{% endblock head %}

{% block content %}
	<div class="graph">
		
	</div>
	<table class="details">
        {% for detail in details.fields %}
            <tr>
                <td>{{detail}}</td>
            </tr>
        {% endfor %}
	</table>
{% endblock content %}
